package flatjsonl_test

import (
	"testing"

	simdjson "github.com/minio/simdjson-go"
	"github.com/stretchr/testify/assert"
	"github.com/valyala/fastjson"
)

func TestFastWalker_WalkFastJSON_invalidJSON(t *testing.T) {
	v, err := fastjson.ParseBytes([]byte(`[127.0.0.1]`))
	assert.NoError(t, err)
	assert.Nil(t, v)
}

func TestFastWalker_GetKey_err(t *testing.T) {
	_, err := simdjson.Parse([]byte(`[127.0.0.1]`), nil)
	assert.Error(t, err)
}

func TestFastWalker_GetKey(t *testing.T) {
	// pj, err := simdjson.Parse([]byte(`{"Image":{"URL":"http://example.com/example.gif"}}`), nil)
}

var line = []byte(`{"tag": "event", "host": "ams-attribution-24", "nonce": "hnz1eve6l", "topic": "event", "context": {"adid": "dab7c7519b47faef219b277cad4751b9", "callback": {"Data": {"Mcc": "310", "Mnc": "410", "Adid": "dab7c7519b47faef219b277cad4751b9", "SkTs": "0001-01-01T00:00:00Z", "Nonce": "m6uip7yfy", "OsName": "android", "Random": "487806771", "Region": "us", "AppName": "in.playsimple.tripcross", "Country": "us", "CpuType": "arm64-v8a", "OsBuild": "TP1A.220624.014", "Tracker": "oii1rju", "ApiLevel": "33", "AppToken": "yi754iuv045c", "Deeplink": "wordjam://", "Language": "en", "Platform": 1, "ClickTime": "2022-08-21T00:34:00Z", "ClientSdk": "android4.28.0", "IpAddress": "174.61.101.129", "OsVersion": "13", "TimeSpent": "15", "UserAgent": "Dalvik/2.1.0 (Linux; U; Android 13; SM-G998U Build/TP1A.220624.014)", "AppVersion": "1.450.2", "ClickLabel": "adikteev_retarget", "DeviceName": "GalaxyS21Ultra5G", "DeviceType": "phone", "EventToken": "xol611", "GoogleAdid": "59de9703-57a9-4c84-af89-d4e86790f9a0", "ReceivedAt": "2023-01-31T20:59:29.841116252Z", "ZoneOffset": {"Int": -300, "Valid": true}, "DeviceModel": "unknown", "Environment": "production", "EventCostId": "01013f0744967a02ec0079654dc563d98131dab7c7519b47faef219b277cad4751b9", "InstalledAt": "2021-08-18T15:07:57Z", "LastTracker": "49sz1ty", "ActivityKind": "event", "HardwareName": "TP1A.220624.014.G998USQS5DVL1", "Manufacturer": "Samsung", "ReferenceTag": "cHbYU85brBmtg", "SessionCount": "367", "CreatedAtTime": "2023-01-31T20:59:29Z", "DeviceAtlasId": 62409517, "ReinstalledAt": "0001-01-01T00:00:00Z", "UninstalledAt": "0001-01-01T00:00:00Z", "EngagementType": 10, "InstallTracker": "8ax45wr", "SKRegisteredAt": "0001-01-01T00:00:00Z", "AppVersionShort": "unknown", "LastSessionTime": "2023-01-31T20:59:13Z", "TrackingEnabled": "1", "FirstSessionTime": "2022-08-21T00:34:06Z", "PartnerSdkParams": {"b": "450", "cli": "0", "gid": "11"}, "PartnerParameters": {"adikteev_id": "YZ8TMCDoEe2hXCGiM0mrug"}, "SKTimerExpiration": "0001-01-01T00:00:00Z", "GlobalSessionCount": 367, "SkSettingsUpdatedAt": "0001-01-01T00:00:00Z", "AttributionUpdatedAt": "0001-01-01T00:00:00Z", "SubscriptionRefundedAt": "0001-01-01T00:00:00Z", "SubscriptionCancelledAt": "0001-01-01T00:00:00Z", "SubscriptionPurchasedAt": "0001-01-01T00:00:00Z", "SkConversionValueNullable": {"Int": 0, "Valid": true}, "SkConversionValueUpdatedAt": "0001-01-01T00:00:00Z", "SubscriptionExpirationTime": "0001-01-01T00:00:00Z", "LastAttributionExpirationTime": "0001-01-01T00:00:00Z", "SKConversionValueWindowExpiration": "0001-01-01T00:00:00Z", "SkConversionValueOnDeviceNullable": {"Int": 0, "Valid": true}, "SkConversionValueOnDeviceUpdatedAt": "0001-01-01T00:00:00Z"}, "Label": "applovin", "CreatedAt": "2023-01-31T20:59:59.879233808Z", "Regulator": {"Cost": false, "Reftags": false, "Revenue": true, "AppToken": false, "EventName": false, "PushToken": false, "PartnerType": 1, "IsAttributed": false, "GeminiApproved": false, "TikTokApproved": false, "LastTrackerName": false, "PublisherParams": false, "TencentApproved": false, "TwitterApproved": false, "ApiPartnerParams": false, "ParameterMapping": null, "SdkPartnerParams": false, "SnapchatApproved": false, "GoogleAdsApproved": false, "InstallTrackerName": false, "OutdatedTrackerName": false, "RokuOneViewApproved": false, "DynamicCallbackParams": false, "AppleSearchAdsApproved": false, "TwitterDataSharingDisallowed": false, "InstallEngagementPartnerParams": true}}, "consumer": "0", "app_token": "yi754iuv045c", "device_ids": {"gps_adid": "59de9703-57a9-4c84-af89-d4e86790f9a0"}, "time_spent": 13443, "event_token": "xol611", "request_url": "http://rt.applovin.com/pix?event=postinstall&sub_event=banner_view&package_name=in.playsimple.tripcross&sdk_key=ZNIvE0h4vR0HKH67IGRflVkPzuDNtX-RwGL8H1CATDSpVTwopMRXsAyp39Bwh9LcQglhiysB9J-fsvReFuB537&platform=android&model=GalaxyS21Ultra5G&idfa=59de9703-57a9-4c84-af89-d4e86790f9a0&device_ip=174.61.101.129&dnt=0&isclaimable=0&brand=Samsung&bundle_id_match=true", "tracker_token": "oii1rju", "response_status": 200}, "message": "callback succeeded", "service": "callback_worker", "timestamp": "2023-01-31T21:00:00.00270603Z"}`)

func BenchmarkFastWalker_GetKey(b *testing.B) {
	b.Run("fastjson_parse", func(b *testing.B) {
		b.ReportAllocs()
		for i := 0; i < b.N; i++ {
			_, _ = fastjson.ParseBytes([]byte(`[127.0.0.1]`))
		}
	})
	b.Run("fastjson_validate", func(b *testing.B) {
		b.ReportAllocs()
		for i := 0; i < b.N; i++ {
			_ = fastjson.ValidateBytes([]byte(`[127.0.0.1]`))
		}
	})
	b.Run("simdjson_parse", func(b *testing.B) {
		b.ReportAllocs()
		reuse := new(simdjson.ParsedJson)

		for i := 0; i < b.N; i++ {
			_, _ = simdjson.Parse([]byte(`[127.0.0.1]`), reuse)
		}
	})
}

func BenchmarkFastWalker_GetKey_line(b *testing.B) {
	b.Run("fastjson_parse", func(b *testing.B) {
		b.ReportAllocs()
		for i := 0; i < b.N; i++ {
			_, _ = fastjson.ParseBytes(line)
		}
	})
	b.Run("fastjson_validate", func(b *testing.B) {
		b.ReportAllocs()
		for i := 0; i < b.N; i++ {
			_ = fastjson.ValidateBytes(line)
		}
	})
	b.Run("simdjson_parse", func(b *testing.B) {
		b.ReportAllocs()
		reuse := new(simdjson.ParsedJson)

		for i := 0; i < b.N; i++ {
			_, _ = simdjson.Parse(line, reuse)
		}
	})
}
